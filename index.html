<!DOCTYPE html>
<html>
<head>
  <title>Nuyina Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.geodesic@2.7.1/dist/leaflet.geodesic.umd.min.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    #controls { position: absolute; top: 10px; right: 10px; background: white;
                padding: 12px; z-index: 1000; border-radius: 4px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-family: sans-serif; font-size: 14px; }
    #controls label { display: block; margin: 8px 0 4px; }
    #controls input[type=range] { width: 100%; }
    #controls button { margin-top: 10px; width: 100%; padding: 6px; }
    .val { float: right; font-weight: bold; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <strong>Nuyina Tracker</strong>
    <div id="info">Loading...</div>
    <label>Records: <span class="val" id="countVal">200</span></label>
    <input type="range" id="count" min="50" max="40000" step="50" value="200">
    <label>Interval (min): <span class="val" id="intervalVal">10</span></label>
    <input type="range" id="interval" min="1" max="1800" step="10" value="10">
    <label><input type="checkbox" id="showCrow" checked> Show crow lines</label>
    <label><input type="checkbox" id="useGC"> Great circle</label>
    <button id="refresh">Refresh</button>
  </div>
  <script>
    const home = [-43.0509891, 147.3423561];
    const map = L.map('map').setView([-43.5, 147.5], 9);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    const homeMarker = L.marker(home).addTo(map).bindPopup('Home');

    let trackLayer = L.layerGroup().addTo(map);

    // haversine distance in km
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function loadTrack() {
      const count = document.getElementById('count').value;
      const interval = document.getElementById('interval').value * 60 * 1000;
      const showCrow = document.getElementById('showCrow').checked;
      const useGC = document.getElementById('useGC').checked;

      document.getElementById('countVal').textContent = count;
      document.getElementById('intervalVal').textContent = document.getElementById('interval').value;

      trackLayer.clearLayers();

      const wfsUrl = 'https://data.aad.gov.au/geoserver/ows?' + new URLSearchParams({
        service: 'WFS',
        version: '2.0.0',
        request: 'GetFeature',
        typeName: 'underway:nuyina_underway',
        outputFormat: 'application/json',
        sortBy: 'datetime D',
        count: count
      });

      fetch(wfsUrl)
        .then(r => r.json())
        .then(data => {
          const features = data.features;

          // filter to intervals
          const selected = [];
          let lastTime = null;
          for (const f of features) {
            const t = new Date(f.properties.datetime);
            if (!lastTime || (lastTime - t) >= interval) {
              selected.push(f);
              lastTime = t;
            }
          }

          // build track line and calculate actual distance
          const trackLine = selected.map(f => {
            const c = f.geometry.coordinates[0];
            return [c[1], c[0]];
          });

          let actualDist = 0;
          for (let i = 1; i < trackLine.length; i++) {
            actualDist += haversine(trackLine[i-1][0], trackLine[i-1][1],
                                    trackLine[i][0], trackLine[i][1]);
          }

          // GC distance from start to end of track
          const startPos = trackLine[trackLine.length - 1];  // oldest point
          const endPos = trackLine[0];  // newest point
          const gcDist = haversine(startPos[0], startPos[1], endPos[0], endPos[1]);

          L.polyline(trackLine, {color: 'red', weight: 2, opacity: 0.6}).addTo(trackLayer);

          // markers and crow lines
          let latestPos, latestTime;
          selected.forEach((f, i) => {
            const coords = f.geometry.coordinates[0];
            const pos = [coords[1], coords[0]];
            const dt = new Date(f.properties.datetime);
            const opacity = 1 - (i / selected.length) * 0.7;

            if (i === 0) {
              latestPos = pos;
              latestTime = dt;
              L.marker(pos, {icon: L.divIcon({html: 'ðŸš¢', className: '', iconSize: [24, 24]})})
                .addTo(trackLayer).bindPopup('Nuyina<br>' + dt.toLocaleString());
            } else {
              L.circleMarker(pos, {radius: 5, fillColor: 'red', fillOpacity: opacity,
                                   stroke: false}).addTo(trackLayer);
            }

            // crow line to home
            if (showCrow) {
              if (useGC) {
                L.geodesic([pos, home], {color: 'blue', weight: 1, opacity: opacity * 0.5}).addTo(trackLayer);
              } else {
                L.polyline([pos, home], {color: 'blue', weight: 1, opacity: opacity * 0.5, dashArray: '3,6'}).addTo(trackLayer);
              }
            }
          });

          map.fitBounds([home, latestPos, trackLine[trackLine.length - 1]], {padding: [50, 50]});

          // distance to home
          const distToHome = haversine(latestPos[0], latestPos[1], home[0], home[1]);

          // ratio
          const ratio = ((actualDist / gcDist - 1) * 100).toFixed(1);

          document.getElementById('info').innerHTML =
            `${latestTime.toLocaleString()}<br>` +
            `${distToHome.toFixed(1)} km to home<br>` +
            `<small>${selected.length} points</small><hr>` +
            `<b>Track:</b> ${actualDist.toFixed(0)} km<br>` +
            `<b>GC:</b> ${gcDist.toFixed(0)} km<br>` +
            `<b>Extra:</b> +${ratio}%`;
        })
        .catch(e => document.getElementById('info').innerHTML = 'Error: ' + e);
    }

    // event listeners
    document.getElementById('refresh').addEventListener('click', loadTrack);
    document.getElementById('count').addEventListener('input', () => {
      document.getElementById('countVal').textContent = document.getElementById('count').value;
    });
    document.getElementById('interval').addEventListener('input', () => {
      document.getElementById('intervalVal').textContent = document.getElementById('interval').value;
    });
    document.getElementById('showCrow').addEventListener('change', loadTrack);
    document.getElementById('useGC').addEventListener('change', loadTrack);

    loadTrack();
  </script>
</body>
</html>
